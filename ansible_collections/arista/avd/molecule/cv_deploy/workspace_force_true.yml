---
- name: "{{ test_id | upper }}  Converge - cv_deploy with cv_submit_workspace_force = true"
  hosts: SITE1_FABRIC:INACTIVE
  connection: local
  gather_facts: false
  vars:
    cv_server: www.cv-staging.corp.arista.io
    cv_token: "{{ lookup('env', 'CVAAS_AAWG_CI') }}"
    cv_verify_certs: true
    cv_skip_missing_devices: true
    eos_config_dir: "{{ playbook_dir }}/intended/configs/test_configs"
    structured_dir: "{{ playbook_dir }}/intended/structured_configs/test_configs"
    intended_tag_device: avd-ci-leaf1
    intended_tags: "{{ lookup('file', structured_dir ~ '/' ~ intended_tag_device ~ '.yml')| from_yaml }}"
    test_id: "workspace-force-true"
    cv_common_pattern: "avd-cv-deploy-{{ test_id }}"

  tasks:
    - name: "{{ test_id | upper }} Banner"
      tags: ["{{ test_id }}"]
      run_once: true
      ansible.builtin.debug:
        msg:
          - "######################################################################"
          - "### STARTING MOLECULE TEST {{ '{:<38}'.format(test_id[:38]) | upper }} ####"
          - "######################################################################"

    - name: "{{ test_id | upper }} Generate random string"
      tags: ["{{ test_id }}"]
      run_once: true
      ansible.builtin.set_fact:
        r: "{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=4') }}"

    - name: "{{ test_id | upper }} Dynamically add inactive device avd-ci-core1 to group INACTIVE"
      tags: ["{{ test_id }}"]
      run_once: true
      ansible.legacy.add_host:
        name: avd-ci-core1
        groups: INACTIVE

    - name: "{{ test_id | upper }} Provision with cv_submit_workspace_force = true"
      tags: ["{{ test_id }}"]
      run_once: true
      delegate_to: localhost
      ansible.builtin.import_role:
        name: arista.avd.cv_deploy
      vars:
        cv_workspace_name: "{{ cv_common_pattern }}-{{ r }}-converge"
        cv_workspace_description: "{{ (cv_common_pattern + '-' + r + '-converge') | upper }}"
        cv_change_control_name: "{{ cv_common_pattern }}-{{ r }}-converge"
        cv_change_control_description: "{{ (cv_common_pattern + '-' + r + '-converge') | upper }}"
        cv_register_detailed_results: true
        cv_devices: [ avd-ci-leaf1, avd-ci-core1 ]
        cv_submit_workspace_force: true

    - name: "{{ test_id | upper }} Display CVP result"
      tags: ["{{ test_id }}"]
      run_once: true
      ansible.builtin.debug:
        msg: '{{ cv_deploy_results }}'

    - name: "{{ test_id | upper }} Check CVP returns"
      tags: ["{{ test_id }}"]
      run_once: true
      ansible.builtin.assert:
        that:
          # errors and warnings
          - cv_deploy_results.errors == []

    - name: "{{ test_id | upper }} Cleanup orphan CC"
      tags: ["{{ test_id }}"]
      run_once: true
      ansible.legacy.uri:
        url: https://{{ cv_server }}/api/resources/changecontrol/v1/ChangeControlConfig?key.id={{ cv_deploy_results.change_control.id }}
        validate_certs: true
        return_content: true
        headers:
          Accept: "application/json"
          Content-Type: "application/json"
          Authorization: "Bearer {{ lookup('env', 'CVAAS_AAWG_CI') }}"
        method: DELETE
        body_format: json
        force_basic_auth: true
        timeout: 10
      register: cvp_abandon_cc_result
      until: cvp_abandon_cc_result.status == 200
      retries: 3
      delay: 3
      ignore_errors: true
      when: cv_deploy_results.change_control.state | lower in ['pending approval', 'approved']

    - name: "{{ test_id | upper }} Cleanup"
      tags: ["{{ test_id }}"]
      run_once: true
      delegate_to: localhost
      ansible.builtin.import_role:
        name: arista.avd.cv_deploy
      vars:
        cv_workspace_name: "{{ cv_common_pattern }}-{{ r }}-cleanup"
        cv_workspace_description: "{{ cv_common_pattern + '-' + r + '-cleanup' | upper }}"
        cv_change_control_name: "{{ cv_common_pattern }}-{{ r }}-cleanup"
        cv_change_control_description: "{{ cv_common_pattern + '-' + r + '-cleanup' | upper }}"
        cv_register_detailed_results: true
        eos_config_dir: "{{ playbook_dir }}/intended/configs/base_configs"
        structured_dir: "{{ playbook_dir }}/intended/structured_configs/base_configs"
        cv_submit_workspace_force: true
        cv_run_change_control: true
