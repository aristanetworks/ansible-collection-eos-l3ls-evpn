<!--
  ~ Copyright (c) 2023 Arista Networks, Inc.
  ~ Use of this source code is governed by the Apache License 2.0
  ~ that can be found in the LICENSE file.
  -->

# cloudvision

## Overview

**cloudvision** is a role designed to apply AVD related changes to CloudVision.
At the moment, the changes supported are:

- Add CloudVision Tags

The **cloudvision** role :

- Designed to have the device inventory as targets.
- Follows the `hosts` definition as would `eos_designs` and `eos_cli_config_gen`
- Works well with intentory groups, and cli `--limit` arguments
- Uses the `delegate_to` functionality to point to the CloudVision instance.

## Role requirements

This role requires the `arista.cvp` collection to support CloudVision interactions. This can be installed using:

```shell
ansible-galaxy collection install arista.cvp
```

!!! note
    When using ansible-cvp modules, the user executing the Ansible playbook must have write access to both CVP and the EOS CLI.

## Role Inputs and Outputs

The role will excute the following tasks in order:

1. Reads the inventory.
2. Role looks for structured configuration previously generated by [`arista.avd.eos_designs`](../eos_designs/README.md).
3. Role looks for any tags that have been generated for each device.
4. Applies any tags found to CloudVision using the [`arista.cvp`](https://github.com/aristanetworks/ansible-cvp/) collection.

### Inputs

**Sturctured Config:**

The role expects that the `structured_config` for the devices to be targeted has already been generated using `eos_designs` role.

Refer to:

- [eos_designs CloudVision Tags](../eos_designs/docs/input-variables.md#cloudvision-tags) for the inputs expected by eos_designs.
- [How-To Guide for CloudVision Tags](../eos_designs/docs/how-to/cloudvision-tags.md)

**Inventory configuration:**

The inventory must include an entry for the CloudVision server.
`arista.cvp` modules use the httpapi connection, and the tasks that imports the cloudvision role must delegate to the CloudVision node as named in the inventory. Refer to the example below that shows such an entry in the inventory.

!!! info
    **As opposed to `eos_config_deploy_cvp`, the target/host that the role expectes to be run against in the playbook is the EOS device. The `delegate_to` functionality should be used to delegate to the cloudvision node listed in the inventory.**

```yaml
all:
  children:
    cloudvision:
      hosts:
        cv_server01:
          ansible_host: 10.83.28.164
          ansible_user: ansible
          ansible_password: ansible
          ansible_connection: httpapi
          ansible_httpapi_use_ssl: True
          ansible_httpapi_validate_certs: False
          ansible_network_os: eos
          ansible_httpapi_port: 443
```

For a complete list of authentication options available with CloudVision Ansible collection, you can read the dedicated page on [arista.cvp collection](https://cvp.avd.sh/en/latest/docs/how-to/cvp-authentication/).

#### Getting Started

Below is an example of how to use role:

```yaml
- name: Apply CloudVision Tags
  hosts: DC1_FABRIC
  gather_facts: false
  tasks:
    - name: Apply Generated CloudVision Tags
      ansible.builtin.import_role:
          name: arista.avd.cloudvision
      delegate_to: cv_server01
```

#### Ignore devices not provisioned in CloudVision

When you want to apply CloudVision tags to a complete topology and devices aren't already in CloudVision, you can configure inventory to ignore these devices by using a host variable: `is_deployed`.

- `is_deployed: true` or `is_deployed is not defined`: The tags for this device are applied on CloudVision
- `is_deployed: false`: Device is skipped.

Here is an overview with the key configured in the YAML inventory:

```yaml
  DC1_BL_LEAFS:
    hosts:
      DC1-BL1A:
        # is_deployed is assumed to be True
        # Device configuration is generated by AVD
        # Device configurationa and tags are applied on Cloudvision
      DC1-BL2A:
        # Device configuration is generated by AVD
        # Device is not configured on Cloudvision and no CloudVision tags are applied.
        is_deployed: false
```

### Outputs

- No outputs to Ansible or to file. All changes are made via API calls to CloudVision.

## Requirements

Requirements are located here: [avd-requirements](../../README.md#Requirements)

## License

Project is published under [Apache 2.0 License](../../LICENSE)
