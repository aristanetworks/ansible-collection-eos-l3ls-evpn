# cloudvision

## Overview

**cloudvision** is a role designed to apply AVD related changes to CloudVision.
At the moment, the changes supported are:

- Add CloudVision Tags

The **cloudvision** role :

- Designed to have the device inventory as targets.
- Follows the `hosts` definition as would `eos_designs` and `eos_cli_config_gen`
- Works well with intentory groups, and cli `--limit` arguments

## Role requirements

This role requires to install `arista.cvp` collection to support CloudVision interactions.

```shell
ansible-galaxy collection install arista.cvp
```

!!! note
    When using ansible-cvp modules, the user executing the Ansible playbook must have access to both CVP and the EOS CLI.

## Role Inputs and Outputs

<!-- Figure 1 below provides a visualization of the role's inputs, outputs, and tasks in order executed by the role. -->
<!--
![Figure 1: Ansible Role eos_config_deploy_eapi](../../docs/_media/eos_config_deploy_cvp_dark.svg#only-dark)
![Figure 1: Ansible Role eos_config_deploy_eapi](../../docs/_media/eos_config_deploy_cvp_light.svg#only-light) -->

1. Read inventory
2. Role looks for structured configuration previously generated by [`arista.avd.eos_designs`](../eos_designs/README.md)
3. Role looks for any tags that have been generated for the device.
4. Applies any tags found to CloudVision using [`arista.cvp`](https://github.com/aristanetworks/ansible-cvp/) collection

### Inputs

**Sturctured Config:**

The role expects that the `structured_config` for the devices to be target has already been generated using `eos_designs` role. Refer to [eos_desing CloudVision Tags](../eos_designs/docs/input-variables.md#cloudvision-tags)

**Inventory configuration:**

An entry must be part of the inventory to describe the CloudVision server. `arista.cvp` modules use the httpapi approach. The example below provides a framework to use in your inventory.

!!! info
    As opposed to `eos_config_deploy_cvp`, the target/host that the role expectes to be run against in the playbook is the EOS device. The `cloudvision_node` should be indicated to the role as a separate variable.**

```yaml
all:
  children:
    cloudvision:
      hosts:
        cv_server01:
          ansible_host: 10.83.28.164
          ansible_user: ansible
          ansible_password: ansible
          ansible_connection: httpapi
          ansible_httpapi_use_ssl: True
          ansible_httpapi_validate_certs: False
          ansible_network_os: eos
          ansible_httpapi_port: 443
```

For a complete list of authentication options available with CloudVision Ansible collection, you can read the dedicated page on [arista.cvp collection](https://cvp.avd.sh/en/latest/docs/how-to/cvp-authentication/).

### Role variables

- **`cloudvision_node`**: The name of the host in the inventory for the CloudVision instance.

#### Getting Started

Below is an example of how to use role:

```yaml
- name: Apply CloudVision Tags
  hosts: DC1_FABRIC
  gather_facts: false
  tasks:
    - name: Apply Generated CloudVision Tags
      ansible.builtin.import_role:
          name: arista.avd.cloudvision
      vars:
        cloudvision_node: cv_server01
```

#### Ignore devices not provisioned in CloudVision

When you want to apply CloudVision tags to a complete topology and devices aren't already in CloudVision, you can configure inventory to ignore these devices by using a host variable: `is_deployed`.

- `is_deployed: true` or `is_deployed is not defined`: The tags for this device are applied on CloudVision
- `is_deployed: false`: Device is skipped.

Here is an overview with the key configured in the YAML inventory:

```yaml
  DC1_BL1:
    hosts:
      DC1-BL1A:
        ansible_port: 8012
  DC1_BL2:
    hosts:
      DC1-BL2A:
        ansible_port: 8012
        # Device configuration is generated by AVD
        # Device is not configured on Cloudvision and no CloudVision tags are applied.
        is_deployed: false
```

### Outputs

- None.

### Tasks

1. Load the `structured_config` created by `eos_designs` and parse the CloudVision tags.
2. Use CloudVision APIs to apply the tags to the devices.

## Requirements

Requirements are located here: [avd-requirements](../../README.md#Requirements)

## License

Project is published under [Apache 2.0 License](../../LICENSE)
