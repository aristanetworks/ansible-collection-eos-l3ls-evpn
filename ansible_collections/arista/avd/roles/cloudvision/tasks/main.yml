---
- name: "Load tag information from structured config"
  ansible.builtin.include_vars:
    file: "{{ filename }}"
  delegate_to: localhost
  when:
    - structured_config is not defined and lookup('first_found', filename, skip=True, errors='ignore')
    - is_deployed is not arista.avd.defined(false)
  vars:
    filename: "{{ structured_dir }}/{{ inventory_hostname }}.{{ avd_structured_config_file_format }}"

- name: "Update tags on CVP"
  arista.cvp.cv_tag_v3:
    tags:
      - device: "{{ inventory_hostname }}"
        device_tags: "{{ cloudvision_tags.device_tags }}"
        interface_tags: "{{ cloudvision_tags.interface_tags }}"
    mode: assign
    auto_create: true
  delegate_to: "{{ cloudvision_node }}"
  when:
    - is_deployed is not arista.avd.defined(false)
    - cloudvision_tags is arista.avd.defined
