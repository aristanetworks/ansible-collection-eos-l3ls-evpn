---
- name: Set eos_designs facts
  arista.avd.eos_designs_facts:
    avd_switch_facts: true
    #cprofile_file: "eos_designs_facts.prof"
    template_output: true
    conversion_mode: "{{ avd_data_conversion_mode }}"
    validation_mode: "{{ avd_data_validation_mode }}"
  check_mode: false
  run_once: true

- name: Generate cvp_tags
  arista.avd.yaml_templates_to_facts:
    templates:
      - python_module: "ansible_collections.arista.avd.roles.cvp_tags.python_modules.cvp_tags"
        python_class_name: "AvdStructuredConfigTags"
  delegate_to: localhost
  check_mode: false
  changed_when: false

- name: "Create folder {{ cvp_tags_dir_name }} for CVP structured YAML files for CVP Tags"
  tags: [debug, never]
  ansible.builtin.file:
    path: "{{ cvp_tags_dir }}"
    state: directory
    mode: 0775
  delegate_to: localhost
  run_once: True

- name: Save tags to file
  tags: [debug, never]
  delegate_to: localhost
  check_mode: false
  ansible.builtin.copy:
    content: "{{ cvp_tags | to_nice_yaml(indent=2) }}"
    dest: "{{ cvp_tags_dir }}/{{ inventory_hostname }}.yaml"
    mode: 0664

- name: "Create folder {{ documentation_dir_name }} for documentation."
  ansible.builtin.file:
    path: "{{ documentation_dir }}"
    state: directory
    mode: 0775
  delegate_to: localhost
  run_once: True

- name: Generate Documentation
  delegate_to: localhost
  check_mode: false
  ansible.builtin.copy:
    content: "{{ lookup('template', 'documentation.j2') | arista.avd.add_md_toc(skip_lines=3, toc_levels=2) }}"
    dest: "{{ documentation_dir }}/cvp_tags.md"
    mode: 0664
  run_once: true

- name: "Update tags on CVP"
  arista.cvp.cv_tag_v3:
    tags: "{{ cvp_tags }}"
    mode: assign
    auto_create: true
  delegate_to: "{{ cvp_node }}"
  when:
    - not skip_cvp
    - not hostvars[inventory_hostname].is_deployed is arista.avd.defined(false)
