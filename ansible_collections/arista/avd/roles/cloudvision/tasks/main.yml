# Copyright (c) 2023 Arista Networks, Inc.
# Use of this source code is governed by the Apache License 2.0
# that can be found in the LICENSE file.
---
- name: "Load tag information from structured config"
  ansible.builtin.include_vars:
    file: "{{ filename }}"
  delegate_to: localhost
  when:
    - structured_config is not defined and lookup('first_found', filename, skip=True, errors='ignore')
    - is_deployed is not arista.avd.defined(false)
  vars:
    filename: "{{ structured_dir }}/{{ inventory_hostname }}.{{ avd_structured_config_file_format }}"

# We want to alert the user that in most cases this role should be used
# with `delegate_to` to make changes on the CloudVision instance.
- name: "Check that role has been delegated"
  ansible.builtin.assert:
    that:
      - ansible_host != hostvars[inventory_hostname].ansible_host | arista.avd.default('NONE')
      - ansible_host != inventory_hostname
    fail_msg: "It appears this role was not called with delegated_to for {{ inventory_hostname }}. Refer to documentation about why this might be an issue."
    quiet: True
  failed_when: False

- name: "Update tags on CVP"
  arista.cvp.cv_tag_v3:
    tags:
      - device: "{{ inventory_hostname }}"
        device_tags: "{{ cv_tags.device_tags }}"
        interface_tags: "{{ cv_tags.interface_tags }}"
    mode: assign
    auto_create: true
  when:
    - is_deployed is not arista.avd.defined(false)
    - cv_tags is arista.avd.defined
