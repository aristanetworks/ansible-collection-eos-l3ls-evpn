{# PBR policy-map #}
{% for policy_map in policy_maps.pbr | arista.avd.natural_sort %}
!
policy-map type pbr {{ policy_map }}
{%     set delimiter = namespace(is_set = false) %}
{%     for class in policy_maps.pbr[policy_map].classes | arista.avd.default([]) %}
{%         set class_cli = 'class ' ~ class %}
{%         if policy_maps.pbr[policy_map].classes[class].index is arista.avd.defined %}
{%             set class_cli = policy_maps.pbr[policy_map].classes[class].index ~ ' ' ~ class_cli %}
{%         endif %}
{%         if delimiter.is_set %}
   !
{%         endif %}
   {{ class_cli }}
{%         set delimiter.is_set = true %}
{%         if policy_maps.pbr[policy_map].classes[class].set.nexthop.ip_address is arista.avd.defined %}
{%             set nexthop_cli = 'set nexthop' %}
{%             if policy_maps.pbr[policy_map].classes[class].set.nexthop.recursive is arista.avd.defined(true) %}
{%                 set nexthop_cli = nexthop_cli ~ ' recursive' %}
{%             endif %}
{%             set nexthop_cli = nexthop_cli ~ ' ' ~ policy_maps.pbr[policy_map].classes[class].set.nexthop.ip_address %}
      {{ nexthop_cli }}
{%         endif %}
{%         if policy_maps.pbr[policy_map].classes[class].drop is arista.avd.defined(true) %}
      drop
{%         endif %}
{%     endfor %}
{% endfor %}
