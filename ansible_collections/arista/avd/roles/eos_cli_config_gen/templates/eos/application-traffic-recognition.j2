{#
 Copyright (c) 2023 Arista Networks, Inc.
 Use of this source code is governed by the Apache License 2.0
 that can be found in the LICENSE file.
#}
{# eos - application traffic recognition #}
{% if application_traffic_recognition is arista.avd.defined %}
!
application traffic recognition
{# categories #}
{%     for category in application_traffic_recognition.categories | arista.avd.natural_sort('name') %}
{%         if category.name is arista.avd.defined %}
   category {{ category.name }}
{%             for app_details in category.applications_and_services %}
{%                 if app_details.service is  arista.avd.defined %}
      application {{ app_details.name }} service {{ app_details.service }}
{%                 else %}
      application {{ app_details.name }}
{%                 endif %}
{%             endfor %}
   !
{%         endif %}
{%     endfor %}
{%     if application_traffic_recognition.port_range_sets is arista.avd.defined %}
{%         for port_range in application_traffic_recognition.port_range_sets %}
{%             if port_range.name is arista.avd.defined %}
   field-set l4-port {{ port_range.name }}
{%                 for port in port_range.ports %}
      {{ port }}
{%                 endfor %}
   !
{%             endif %}
{%         endfor %}
{%     endif %}
{%     if application_traffic_recognition.prefix_sets is arista.avd.defined %}
{%         for prefix_set in application_traffic_recognition.prefix_sets %}
{%             if prefix_set.name is arista.avd.defined %}
   field-set ipv4 prefix {{ prefix_set.name }}
{%                 for prefix in prefix_set.prefixes %}
      {{ prefix }}
{%                 endfor %}
   !
{%             endif %}
{%         endfor %}
{%     endif %}
{%     if application_traffic_recognition.user_defined_ipv4_applications is arista.avd.defined %}
{%         for application in application_traffic_recognition.user_defined_ipv4_applications %}
{%             if application.name is arista.avd.defined %}
   application ipv4 {{ application.name }}
{%                 if application.src_prefix_set_name is arista.avd.defined %}
      source prefix field-set {{ application.src_prefix_set_name }}
{%                 endif %}
{%                 if application.dest_prefix_set_name is arista.avd.defined %}
      destination prefix field-set {{ application.dest_prefix_set_name }}
{%                 endif %}
{%                 if application.protocol is arista.avd.defined %}
{%                     set config = [application.protocol] %}
{%                     if application.src_port_set_name is arista.avd.defined %}
{%                         do config.append("source port field-set " + application.src_port_set_name) %}
{%                     endif %}
{%                     if application.dest_port_set_name is arista.avd.defined %}
{%                         do config.append("destination port field-set " + application.dest_port_set_name) %}
{%                     endif %}
      protocol {{ config | join(" ") }}
{%                 endif %}
{%             endif %}
{%         endfor %}
   !
{%     endif %}
{%     for application_profile in application_traffic_recognition.application_profiles %}
   application-profile {{ application_profile.name }}
{%         for application in application_profile.applications %}
{%             if application.service is arista.avd.defined %}
      application {{ application.name }} service {{ application.service }}
{%             else %}
      application {{ application.name }}
{%             endif %}
{%         endfor %}
{%         for transport in application_profile.transports %}
      application {{ transport }} transport
{%         endfor %}
{%         for category in application_profile.categories %}
{%             if category.service is arista.avd.defined %}
      category {{ category.name }} service {{ category.service }}
{%             else %}
      category {{ category.name }}
{%             endif %}
{%         endfor %}
   !
{%     endfor %}
{% endif %}
