{#
 Copyright (c) 2023 Arista Networks, Inc.
 Use of this source code is governed by the Apache License 2.0
 that can be found in the LICENSE file.
#}
{# doc - dhcp server #}
{% set ethernet_interfaces_dhcp_server = [] %}
{% for ethernet_interface in ethernet_interfaces | arista.avd.natural_sort('name') %}
{%     if ethernet_interface.dhcp_server_ipv4 is arista.avd.defined(true) or ethernet_interface.dhcp_server_ipv4 is arista.avd.defined(true) %}
{%         do ethernet_interfaces_dhcp_server.append(ethernet_interface) %}
{%     endif %}
{% endfor %}
{% if (ethernet_interfaces_dhcp_server | length > 0 or dhcp_servers is arista.avd.defined) %}

## DHCP Server
{%     if dhcp_servers is arista.avd.defined %}

### DHCP Servers Summary

| DHCP Server Enabled | VRF | IPv4 DNS Domain | IPv6 DNS Domain |
| ------------------- | --- | --------------- | --------------- |
{%         for dhcp_server in dhcp_servers | arista.avd.natural_sort("vrf") %}
{%             set dhcp_server_vrf = dhcp_server.vrf | arista.avd.default("-") %}
| {{ not dhcp_server.disabled | arista.avd.default(false) }} | {{ dhcp_server_vrf }} | {{ dhcp_server.dns_domain_name_ipv4 | arista.avd.default("-") }} | {{ dhcp_server.dns_domain_name_ipv6 | arista.avd.default("-") }} |
{%         endfor %}
{%         for dhcp_server in dhcp_servers | arista.avd.natural_sort("vrf") %}
{%             set dhcp_server_vrf = dhcp_server.vrf | arista.avd.default("default") %}
{%             set dhcp_server_subnets = [] %}
{%             set dhcp_vendor_options = [] %}
{%             for subnet in dhcp_server.subnets | arista.avd.natural_sort %}
{%                 set subnet_dns_servers = subnet.dns_servers | arista.avd.default(["-"]) | join(", ") %}
{%                 if subnet.lease_time is arista.avd.defined %}
{%                     set subnet_lease_time = subnet.lease_time.days ~ " days, " ~ subnet.lease_time.hours ~ " hours, " ~ subnet.lease_time.minutes ~ " minutes" %}
{%                 else %}
{%                     set subnet_lease_time = "-" %}
{%                 endif %}
{%                 set subnet_default_gw = subnet.default_gateway | arista.avd.default("-") %}
{%                 set subnet_ranges = [] %}
{%                 for range in subnet.ranges | arista.avd.natural_sort("start") %}
{%                     do subnet_ranges.append(range.start ~ "-" ~ range.end) %}
{%                 endfor %}
{%                 do dhcp_server_subnets.append({"subnet": subnet.subnet, "vrf": dhcp_server_vrf, "dns_servers": subnet_dns_servers, "lease_time": subnet_lease_time, "default_gateway": subnet_default_gw , "ranges": subnet_ranges | join(", ")}) %}
{%             endfor %}
{%             for option in dhcp_server.ipv4_vendor_options | arista.avd.natural_sort("vendor_id") %}
{%                 do dhcp_vendor_options.append({"vendor_id": option.vendor_id, "sub_options": option.sub_options}) %}
{%             endfor %}
{%             if dhcp_server_subnets | length > 0 %}

#### VRF {{ dhcp_server_vrf }} DHCP Server Subnets

| Subnet | VRF | DNS Servers | Default Gateway | Lease Time | Ranges |
| ------ | --- | ----------- | --------------- | ---------- | ------ |
{%                 for subnet in dhcp_server_subnets %}
| {{ subnet.subnet }} | {{ subnet.vrf }} | {{ subnet.dns_servers }} | {{ subnet.default_gateway }} | {{ subnet.lease_time }} | {{ subnet.ranges }} |
{%                 endfor %}
{%             endif %}
{%             if dhcp_vendor_options | length > 0 %}

#### VRF {{ dhcp_server_vrf }} DHCP Server IPv4 Vendor Options

| Vendor ID | Sub-option Code | Sub-option Type | Sub-option Data |
| --------- | ----------------| --------------- | --------------- |
{%                 for option in dhcp_vendor_options | arista.avd.natural_sort("vendor_id") %}
{%                     for sub_option in option.sub_options | arista.avd.natural_sort("code") %}
| {{ option.vendor_id }} | {{ sub_option.code }} | {{ sub_option.type }} | {{ sub_option.data }} |
{%                     endfor %}
{%                 endfor %}
{%             endif %}
{%         endfor %}

### DHCP Server Configuration

```eos
{%         include 'eos/dhcp-servers.j2' %}
```
{%     endif %}
{%     if ethernet_interfaces_dhcp_server | length > 0 %}

### DHCP Server interfaces

| Interface name | DHCP IPv4 | DHCP IPv6 |
| -------------- | --------- | --------- |
{%         for ethernet_interface in ethernet_interfaces_dhcp_server | arista.avd.natural_sort %}
| {{ ethernet_interface.name }} | {{ ethernet_interface.dhcp_server_ipv4 | arista.avd.default(false) }} | {{ ethernet_interface.dhcp_server_ipv6 | arista.avd.default(false) }} |
{%         endfor %}
{%     endif %}
{% endif %}
